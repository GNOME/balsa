#!/bin/sh
# $Id$

echo "starting test environment:"

echo "echo server @ port 65000 as e_echo..."
@SCREEN@ -d -m -S e_echo @abs_srcdir@/echoserver.py
echo "GnuTLS server w/o client checking @ port 65001 as s_server1..."
@SCREEN@ -d -m -S s_server1 \
	@GTLSSRV@ --disable-client-cert \
	--x509keyfile=cert_u.pem --x509certfile=cert_u.pem --priority="NORMAL:-VERS-TLS1.3" --echo --crlf -p 65001
echo "GnuTLS server w/ client checking @ port 65002 as s_server2..."
@SCREEN@ -d -m -S s_server2 \
	@GTLSSRV@ --require-client-cert --verify-client-cert --x509keyfile=cert_u.pem \
	--x509certfile=cert_u.pem --x509cafile=ca_cert.pem --priority="NORMAL:-VERS-TLS1.3" --echo --crlf -p 65002
@SCREEN@ -ls

echo "inetsim (as root)..."
@SUDO@ -s -- <<EOF
rm -rf inetsim-1 inetsim-2
mkdir inetsim-1 inetsim-2
@INETSIM@ --config inetsim-1.conf --pidfile=inetsim-1/pid --report-dir inetsim-1 --log-dir inetsim-1 &
sleep 5
@INETSIM@ --config inetsim-2.conf --pidfile=inetsim-2/pid --report-dir inetsim-2 --log-dir inetsim-2
sleep 5
chmod 666 debug.log main.log service.log report.*.txt
EOF

echo "shut down echo and GnuTLS servers..."
@SCREEN@ -S e_echo -X quit
@SCREEN@ -S s_server1 -X stuff $'\003'
@SCREEN@ -S s_server2 -X stuff $'\003'
